<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IM Work</title>
</head>
<body>
<h1>IM Work</h1>
<select name="u_name" id="u_name">
<option value="all">全部</option>
{foreach $userList as $val}
<option value="{$val}">{$val}</option>
{/foreach}
</select>
<input type="text" id="msg">
<button type="button" id="send">send</button>
<div id="content"></div>
</body>

<script type="text/javascript">
	
	var ws, name;
	
	function connect() {
		ws = new WebSocket("ws://123.56.192.63:2346");
        document.getElementById("send").onclick = onsend;
        ws.onopen = onopen;
        ws.onmessage = onmessage;
		ws.onclose = function() {
			console.log("连接关闭，定时重连");
			connect();
		};
		ws.onerror = function() {
			console.log("出现错误");
		};
	}
	
	// 建立连接
	function onopen()
	{
		if (!name) {
			name = prompt('输入你的名字：', '');
			if (!name || name=='null') {  
				name = '游客';
			}
		}
		var login_data = '{"type":"login", "client_name":"'+name.replace(/"/g, '\\"')+'", "room_id":"房间1"}';
		console.log(login_data);
		ws.send(login_data);
	}
	
	// 发送消息
	function onsend()
	{
		var u_name = document.getElementById("u_name").value;
		var msg = document.getElementById("msg").value;
		var message = '{"type":"say", "client_name":"' + u_name + '", "data":"' + msg + '", "room_id":"房间1"}';
		ws.send(message);
	}
	
	// 接收消息
	function onmessage(e)
	{
		var data = eval("("+e.data+")");
		switch (data['type']) {
			// ping
			case 'ping':
				ws.send('{"type":"pong"}');
				break;;
			// send
			case 'say':
				document.getElementById("content").innerHTML += "<h2>" + data['data'] + "</h2>";
				break;;
			// open
			case 'login':
				document.getElementById("content").innerHTML += "<h2>" + data['data'] + "</h2>";
		}
	}
	
	window.onload = function () {
        connect();
    };
</script>

</html>
